<div class="daw-container">
  <nz-layout>
    <nz-header class="daw-header">
      <div class="header-content">
        <h1>Guitare DAW</h1>
        <div class="transport-controls">
          <button
            nz-button
            nzType="default"
            (click)="startAudioContext()"
            *ngIf="!isAudioContextStarted"
          >
            <span nz-icon nzType="play-circle"></span> Démarrer Audio
          </button>
          <span *ngIf="isAudioContextStarted" class="audio-status-ok">
            <span nz-icon nzType="check-circle"></span> Audio Prêt
          </span>

          <button
            nz-button
            nzType="primary"
            [disabled]="!isAudioContextStarted"
            (click)="toggleAudioPlayback()"
            class="control-button"
          >
            <span
              nz-icon
              [nzType]="isPlaying ? 'pause' : 'play-circle'"
              nzTheme="outline"
            ></span>
            {{ isPlaying ? "Pause" : "Lecture" }}
          </button>
          <button nz-button [disabled]="!isAudioContextStarted">
            <span nz-icon nzType="reload"></span>
          </button>
          <button
            nz-button
            nzType="primary"
            (click)="showDeviceDrawer()"
            [disabled]="!isAudioContextStarted"
          >
            <span nz-icon nzType="audio"></span>
            Périphériques
          </button>
        </div>
        <div class="audio-meter">
          <canvas #visualizer width="300" height="50"></canvas>
        </div>
      </div>
    </nz-header>

    <nz-layout>
      <nz-sider nzWidth="300px" class="daw-sider">
        <div class="effects-panel">
          <h2>Effets</h2>
          <div class="effect-buttons">
            <button
              nz-button
              (click)="addEffect('delay')"
              class="effect-button"
              [disabled]="!isAudioContextStarted"
            >
              <span nz-icon nzType="clock-circle"></span>
              Delay
            </button>
            <button
              nz-button
              (click)="addEffect('reverb')"
              class="effect-button"
              [disabled]="!isAudioContextStarted"
            >
              <span nz-icon nzType="sound"></span>
              Reverb
            </button>
            <button
              nz-button
              (click)="addEffect('distortion')"
              class="effect-button"
              [disabled]="!isAudioContextStarted"
            >
              <span nz-icon nzType="thunderbolt"></span>
              Distortion
            </button>
            <button
              nz-button
              (click)="addEffect('eq')"
              class="effect-button"
              [disabled]="!isAudioContextStarted"
            >
              <span nz-icon nzType="line-chart"></span>
              EQ
            </button>
            <button
              nz-button
              (click)="addEffect('pitchShifter')"
              class="effect-button"
              [disabled]="!isAudioContextStarted"
            >
              <span nz-icon nzType="rise"></span>
              Pitch Shifter
            </button>
            <button
              nz-button
              (click)="addEffect('compressor')"
              class="effect-button"
              [disabled]="!isAudioContextStarted"
            >
              <span nz-icon nzType="compress"></span>
              Compresseur
            </button>
            <button
              nz-button
              (click)="addEffect('phaser')"
              class="effect-button"
              [disabled]="!isAudioContextStarted"
            >
              <span nz-icon nzType="swap"></span>
              Phaser
            </button>
            <button
              nz-button
              (click)="addEffect('flanger')"
              class="effect-button"
              [disabled]="!isAudioContextStarted"
            >
              <span nz-icon nzType="sync"></span>
              Flanger
            </button>
            <button
              nz-button
              (click)="addEffect('fuzz')"
              class="effect-button"
              [disabled]="!isAudioContextStarted"
            >
              <span nz-icon nzType="fire"></span>
              Fuzz
            </button>
            <button
              nz-button
              (click)="addEffect('overdrive')"
              class="effect-button"
              [disabled]="!isAudioContextStarted"
            >
              <span nz-icon nzType="thunderbolt"></span>
              Overdrive
            </button>
          </div>

          <div class="effect-chain">
            <h3>Chaîne d'effets</h3>
            <div
              cdkDropList
              class="effect-list"
              (cdkDropListDropped)="onDrop($event)"
            >
              <div
                class="effect-box"
                *ngFor="let effectInfo of effectInfos"
                cdkDrag
              >
                <div class="effect-header">
                  <span nz-icon nzType="drag" class="drag-handle"></span>
                  <span class="effect-name">{{ effectInfo.name }}</span>
                  <div class="effect-actions">
                    <button
                      nz-button
                      nzType="text"
                      (click)="toggleEffectPanel(effectInfo.id)"
                      class="effect-toggle-btn"
                    >
                      <span
                        nz-icon
                        [nzType]="effectInfo.isOpen ? 'up' : 'down'"
                      ></span>
                    </button>
                    <button
                      nz-button
                      nzType="text"
                      (click)="removeEffect(effectInfo.id)"
                    >
                      <span nz-icon nzType="close"></span>
                    </button>
                  </div>
                </div>
                <!-- Panneau de paramètres d'effets -->
                <div class="effect-params" *ngIf="effectInfo.isOpen">
                  <div
                    class="param-item"
                    *ngFor="let param of effectInfo.params"
                  >
                    <label class="param-label">{{ param.name }}</label>
                    <!-- Type Slider -->
                    <div *ngIf="param.type === 'slider'" class="param-control">
                      <nz-slider
                        [nzMin]="param.min"
                        [nzMax]="param.max"
                        [nzStep]="param.step"
                        [ngModel]="param.value"
                        (ngModelChange)="
                          updateEffectParam(effectInfo, param, $event)
                        "
                      ></nz-slider>
                      <span class="param-value">{{
                        formatParamValue(param.value)
                      }}</span>
                    </div>
                    <!-- Type Toggle -->
                    <div *ngIf="param.type === 'toggle'" class="param-control">
                      <nz-switch
                        [ngModel]="param.value"
                        (ngModelChange)="
                          updateEffectParam(effectInfo, param, $event)
                        "
                      ></nz-switch>
                    </div>
                    <!-- Type Select -->
                    <div *ngIf="param.type === 'select'" class="param-control">
                      <nz-select
                        style="width: 100%"
                        [ngModel]="param.value"
                        (ngModelChange)="
                          updateEffectParam(effectInfo, param, $event)
                        "
                      >
                        <nz-option
                          *ngFor="let option of param.options"
                          [nzValue]="option.value"
                          [nzLabel]="option.label"
                        ></nz-option>
                      </nz-select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nz-sider>

      <nz-content class="daw-content">
        <div class="main-workspace">
          <div class="track-view">
            <div class="track-header">
              <h3>Piste Guitare</h3>
              <div class="track-controls">
                <button
                  nz-button
                  nzType="text"
                  [disabled]="!isAudioContextStarted"
                >
                  <span nz-icon nzType="sound"></span>
                </button>
                <button
                  nz-button
                  nzType="text"
                  [disabled]="!isAudioContextStarted"
                >
                  <span nz-icon nzType="setting"></span>
                </button>
              </div>
            </div>
            <div class="track-content">
              <div class="waveform-display"></div>
            </div>
          </div>

          <div class="presets-module">
            <nz-tabset>
              <nz-tab nzTitle="Presets">
                <div class="presets-content">
                  <!-- Formulaire d'ajout de preset -->
                  <div class="add-preset-form">
                    <nz-input-group [nzSuffix]="suffixButton">
                      <input
                        nz-input
                        [(ngModel)]="newPresetName"
                        placeholder="Nom du preset"
                        [disabled]="
                          !isAudioContextStarted || effectInfos.length === 0
                        "
                      />
                    </nz-input-group>
                    <ng-template #suffixButton>
                      <button
                        nz-button
                        nzType="primary"
                        (click)="savePreset()"
                        [disabled]="
                          !newPresetName.trim() ||
                          !isAudioContextStarted ||
                          effectInfos.length === 0
                        "
                      >
                        <span nz-icon nzType="save"></span>
                        Sauvegarder
                      </button>
                    </ng-template>
                  </div>

                  <!-- Liste des presets -->
                  <div class="presets-list">
                    <nz-card *ngFor="let preset of presets" class="preset-card">
                      <div class="preset-header">
                        <h3>{{ preset.name }}</h3>
                        <div class="preset-actions">
                          <button
                            nz-button
                            nzType="primary"
                            (click)="loadPreset(preset)"
                            [disabled]="!isAudioContextStarted"
                          >
                            <span nz-icon nzType="play-circle"></span>
                            Charger
                          </button>
                          <button
                            nz-button
                            nzType="default"
                            nzDanger
                            (click)="deletePreset(preset)"
                          >
                            <span nz-icon nzType="delete"></span>
                          </button>
                        </div>
                      </div>
                      <div class="preset-info">
                        <p>{{ preset.effects.length }} effet(s)</p>
                        <div class="preset-effects-list">
                          <nz-tag *ngFor="let effect of preset.effects">
                            {{ getEffectName(effect.type) }}
                          </nz-tag>
                        </div>
                      </div>
                    </nz-card>

                    <nz-empty
                      *ngIf="presets.length === 0"
                      [nzNotFoundContent]="'Aucun preset sauvegardé'"
                      [nzNotFoundFooter]="footerTemplate"
                    >
                    </nz-empty>
                    <ng-template #footerTemplate>
                      <p>
                        Ajoutez des effets et sauvegardez votre premier preset
                      </p>
                    </ng-template>
                  </div>
                </div>
              </nz-tab>

              <nz-tab nzTitle="Mix">
                <div class="mix-content">
                  <nz-card>
                    <h3>Mix Général</h3>
                    <div class="mix-controls">
                      <!-- Volume général -->
                      <div class="control-group">
                        <label>Volume</label>
                        <nz-slider
                          [nzMin]="-60"
                          [nzMax]="0"
                          [nzStep]="1"
                          [(ngModel)]="masterVolume"
                          (ngModelChange)="updateMasterVolume($event)"
                          [disabled]="!isAudioContextStarted"
                        ></nz-slider>
                        <span class="value">{{ masterVolume }} dB</span>
                      </div>

                      <!-- Pan général -->
                      <div class="control-group">
                        <label>Balance</label>
                        <nz-slider
                          [nzMin]="-1"
                          [nzMax]="1"
                          [nzStep]="0.1"
                          [(ngModel)]="masterPan"
                          (ngModelChange)="updateMasterPan($event)"
                          [disabled]="!isAudioContextStarted"
                        ></nz-slider>
                        <span class="value">{{
                          masterPan | number : "1.1-1"
                        }}</span>
                      </div>

                      <!-- Monitoring -->
                      <div class="meters">
                        <div class="vu-meter">
                          <div class="meter-label">Niveau</div>
                          <div class="meter-bar">
                            <div
                              class="meter-fill"
                              [style.height.%]="vuMeterLevel"
                            ></div>
                          </div>
                          <div class="meter-value">
                            {{ vuMeterLevel | number : "1.0-0" }}%
                          </div>
                        </div>
                      </div>
                    </div>
                  </nz-card>
                </div>
              </nz-tab>

              <nz-tab nzTitle="Visualisateur">
                <div class="visualizer-content">
                  <nz-card>
                    <div class="visualizer-controls">
                      <nz-radio-group
                        [(ngModel)]="visualizerType"
                        (ngModelChange)="updateVisualizerType()"
                      >
                        <label nz-radio-button nzValue="waveform"
                          >Forme d'onde</label
                        >
                        <label nz-radio-button nzValue="frequency"
                          >Fréquences</label
                        >
                      </nz-radio-group>
                    </div>
                    <div class="visualizer-container">
                      <canvas #mainVisualizer></canvas>
                    </div>
                  </nz-card>
                </div>
              </nz-tab>
            </nz-tabset>
          </div>
        </div>
      </nz-content>
    </nz-layout>
  </nz-layout>

  <!-- Drawer pour la sélection des périphériques -->
  <nz-drawer
    [nzVisible]="isDeviceDrawerVisible"
    nzTitle="Sélection des périphériques audio"
    (nzOnClose)="closeDeviceDrawer()"
    [nzWidth]="400"
  >
    <ng-container *nzDrawerContent>
      <div class="device-selection">
        <h3>Périphérique d'entrée</h3>
        <p>
          Sélectionnez le périphérique d'entrée audio (microphone ou interface
          audio)
        </p>

        <div *ngIf="getInputDevices().length === 0" class="no-devices">
          <p>Aucun périphérique d'entrée audio trouvé.</p>
          <button
            nz-button
            nzType="primary"
            (click)="guitarAudioService.updateAvailableDevices()"
          >
            <span nz-icon nzType="reload"></span>
            Rafraîchir
          </button>
        </div>

        <nz-select
          *ngIf="getInputDevices().length > 0"
          [(ngModel)]="selectedInputDevice"
          (ngModelChange)="selectDevice($event, true)"
          class="device-select"
        >
          <nz-option
            *ngFor="let device of getInputDevices()"
            [nzValue]="device.id"
            [nzLabel]="device.label"
          ></nz-option>
        </nz-select>

        <h3 class="mt-4">Périphérique de sortie</h3>
        <p>
          Sélectionnez le périphérique de sortie audio (haut-parleurs ou casque)
        </p>

        <div *ngIf="getOutputDevices().length === 0" class="no-devices">
          <p>Aucun périphérique de sortie audio trouvé.</p>
          <button
            nz-button
            nzType="primary"
            (click)="guitarAudioService.updateAvailableDevices()"
          >
            <span nz-icon nzType="reload"></span>
            Rafraîchir
          </button>
        </div>

        <nz-select
          *ngIf="getOutputDevices().length > 0"
          [(ngModel)]="selectedOutputDevice"
          (ngModelChange)="selectDevice($event, false)"
          class="device-select"
        >
          <nz-option
            *ngFor="let device of getOutputDevices()"
            [nzValue]="device.id"
            [nzLabel]="device.label"
          ></nz-option>
        </nz-select>

        <div class="permissions-note">
          <p>
            <span nz-icon nzType="info-circle"></span>
            Si vous ne voyez pas vos périphériques, assurez-vous d'avoir accordé
            les permissions d'accès au microphone à votre navigateur.
          </p>
        </div>
      </div>
    </ng-container>
  </nz-drawer>

  <div class="visualizer-container">
    <canvas #visualizer width="800" height="200"></canvas>
  </div>
</div>
