<div class="daw-container">
  <nz-layout>
    <nz-header class="daw-header">
      <div class="header-content">
        <h1>Guitare DAW</h1>
        <div class="transport-controls">
          <button
            nz-button
            nzType="default"
            (click)="startAudioContext()"
            *ngIf="!isAudioContextStarted"
          >
            <span nz-icon nzType="play-circle"></span> Démarrer Audio
          </button>
          <span *ngIf="isAudioContextStarted" class="audio-status-ok">
            <span nz-icon nzType="check-circle"></span> Audio Prêt
          </span>

          <button
            nz-button
            nzType="primary"
            (click)="togglePlayback()"
            [disabled]="!isAudioContextStarted"
          >
            <span
              nz-icon
              [nzType]="isPlaying ? 'pause-circle' : 'play-circle'"
            ></span>
          </button>
          <button nz-button [disabled]="!isAudioContextStarted">
            <span nz-icon nzType="reload"></span>
          </button>
          <button
            nz-button
            nzType="primary"
            (click)="showDeviceDrawer()"
            [disabled]="!isAudioContextStarted"
          >
            <span nz-icon nzType="audio"></span>
            Périphériques
          </button>
        </div>
        <div class="audio-meter">
          <div class="meter-bar"></div>
        </div>
      </div>
    </nz-header>

    <nz-layout>
      <nz-sider nzWidth="300px" class="daw-sider">
        <div class="effects-panel">
          <h2>Effets</h2>
          <div class="effect-buttons">
            <button
              nz-button
              (click)="addEffect('delay')"
              class="effect-button"
              [disabled]="!isAudioContextStarted"
            >
              <span nz-icon nzType="clock-circle"></span>
              Delay
            </button>
            <button
              nz-button
              (click)="addEffect('reverb')"
              class="effect-button"
              [disabled]="!isAudioContextStarted"
            >
              <span nz-icon nzType="sound"></span>
              Reverb
            </button>
            <button
              nz-button
              (click)="addEffect('distortion')"
              class="effect-button"
              [disabled]="!isAudioContextStarted"
            >
              <span nz-icon nzType="thunderbolt"></span>
              Distortion
            </button>
            <button
              nz-button
              (click)="addEffect('eq')"
              class="effect-button"
              [disabled]="!isAudioContextStarted"
            >
              <span nz-icon nzType="line-chart"></span>
              EQ
            </button>
          </div>

          <div class="effect-chain">
            <h3>Chaîne d'effets</h3>
            <div
              cdkDropList
              class="effect-list"
              (cdkDropListDropped)="onDrop($event)"
            >
              <div
                class="effect-box"
                *ngFor="let effectInfo of effectInfos"
                cdkDrag
              >
                <div class="effect-header">
                  <span nz-icon nzType="drag" class="drag-handle"></span>
                  <span class="effect-name">{{ effectInfo.name }}</span>
                  <div class="effect-actions">
                    <button
                      nz-button
                      nzType="text"
                      (click)="toggleEffectPanel(effectInfo.id)"
                      class="effect-toggle-btn"
                    >
                      <span
                        nz-icon
                        [nzType]="effectInfo.isOpen ? 'up' : 'down'"
                      ></span>
                    </button>
                    <button
                      nz-button
                      nzType="text"
                      (click)="removeEffect(effectInfo.id)"
                    >
                      <span nz-icon nzType="close"></span>
                    </button>
                  </div>
                </div>
                <!-- Panneau de paramètres d'effets -->
                <div class="effect-params" *ngIf="effectInfo.isOpen">
                  <div
                    class="param-item"
                    *ngFor="let param of effectInfo.params"
                  >
                    <label class="param-label">{{ param.name }}</label>
                    <!-- Type Slider -->
                    <div *ngIf="param.type === 'slider'" class="param-control">
                      <nz-slider
                        [nzMin]="param.min"
                        [nzMax]="param.max"
                        [nzStep]="param.step"
                        [ngModel]="param.value"
                        (ngModelChange)="
                          updateEffectParam(effectInfo, param, $event)
                        "
                      ></nz-slider>
                      <span class="param-value">{{
                        param.type === "slider"
                          ? (param.value | number : "1.2-2")
                          : param.value
                      }}</span>
                    </div>
                    <!-- Type Toggle -->
                    <div *ngIf="param.type === 'toggle'" class="param-control">
                      <nz-switch
                        [ngModel]="param.value"
                        (ngModelChange)="
                          updateEffectParam(effectInfo, param, $event)
                        "
                      ></nz-switch>
                    </div>
                    <!-- Type Select -->
                    <div *ngIf="param.type === 'select'" class="param-control">
                      <nz-select
                        style="width: 100%"
                        [ngModel]="param.value"
                        (ngModelChange)="
                          updateEffectParam(effectInfo, param, $event)
                        "
                      >
                        <nz-option
                          *ngFor="let option of param.options"
                          [nzValue]="option.value"
                          [nzLabel]="option.label"
                        ></nz-option>
                      </nz-select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nz-sider>

      <nz-content class="daw-content">
        <div class="main-workspace">
          <div class="track-view">
            <div class="track-header">
              <h3>Piste Guitare</h3>
              <div class="track-controls">
                <button
                  nz-button
                  nzType="text"
                  [disabled]="!isAudioContextStarted"
                >
                  <span nz-icon nzType="sound"></span>
                </button>
                <button
                  nz-button
                  nzType="text"
                  [disabled]="!isAudioContextStarted"
                >
                  <span nz-icon nzType="setting"></span>
                </button>
              </div>
            </div>
            <div class="track-content">
              <div class="waveform-display"></div>
            </div>
          </div>

          <div class="external-apps tab-module">
            <nz-tabset>
              <nz-tab nzTitle="Tablatures">
                <div class="tab-content-wrapper">
                  <app-tab-search
                    (tabSelected)="loadSelectedTab($event)"
                    class="tab-search-panel"
                  ></app-tab-search>
                  <app-tab-viewer
                    [tabUrl]="selectedTabUrl"
                    class="tab-viewer-panel"
                  ></app-tab-viewer>
                </div>
              </nz-tab>
            </nz-tabset>
          </div>
        </div>
      </nz-content>
    </nz-layout>
  </nz-layout>

  <!-- Drawer pour la sélection des périphériques -->
  <nz-drawer
    [nzVisible]="isDeviceDrawerVisible"
    nzTitle="Sélection des périphériques audio"
    (nzOnClose)="closeDeviceDrawer()"
    [nzWidth]="400"
  >
    <ng-container *nzDrawerContent>
      <div class="device-selection">
        <h3>Périphérique d'entrée</h3>
        <p>
          Sélectionnez le périphérique d'entrée audio (microphone ou interface
          audio)
        </p>

        <div *ngIf="availableDevices.length === 0" class="no-devices">
          <p>Aucun périphérique audio trouvé.</p>
          <button
            nz-button
            nzType="primary"
            (click)="guitarAudioService.updateAvailableDevices()"
          >
            <span nz-icon nzType="reload"></span>
            Rafraîchir
          </button>
        </div>

        <nz-select
          *ngIf="availableDevices.length > 0"
          [(ngModel)]="selectedDeviceId"
          (ngModelChange)="selectDevice($event)"
          class="device-select"
        >
          <nz-option
            *ngFor="let device of availableDevices"
            [nzValue]="device.deviceId"
            [nzLabel]="device.label"
          ></nz-option>
        </nz-select>

        <div class="permissions-note">
          <p>
            <span nz-icon nzType="info-circle"></span>
            Si vous ne voyez pas votre périphérique, assurez-vous d'avoir
            accordé les permissions d'accès au microphone à votre navigateur.
          </p>
        </div>
      </div>
    </ng-container>
  </nz-drawer>
</div>
